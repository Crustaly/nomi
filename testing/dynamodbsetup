import boto3
import time
from datetime import datetime
from botocore.exceptions import ClientError

TABLE_NAME = "NomiSensorData"
REGION = "us-east-1"
TTL_HOURS = 3

# --- AWS CONNECTION ---
dynamodb = boto3.client("dynamodb", region_name=REGION)
resource = boto3.resource("dynamodb", region_name=REGION)

# --- 1. CREATE TABLE (if not exists) ---
def create_table_if_not_exists():
    try:
        tables = dynamodb.list_tables()["TableNames"]
        if TABLE_NAME in tables:
            print(f"‚úÖ Table '{TABLE_NAME}' already exists.")
            return
        print(f"üöÄ Creating table '{TABLE_NAME}'...")
        dynamodb.create_table(
            TableName=TABLE_NAME,
            KeySchema=[
                {"AttributeName": "sensor_type", "KeyType": "HASH"},  # Partition key
                {"AttributeName": "timestamp", "KeyType": "RANGE"},   # Sort key
            ],
            AttributeDefinitions=[
                {"AttributeName": "sensor_type", "AttributeType": "S"},
                {"AttributeName": "timestamp", "AttributeType": "S"},
            ],
            BillingMode="PAY_PER_REQUEST",
        )
        waiter = dynamodb.get_waiter("table_exists")
        waiter.wait(TableName=TABLE_NAME)
        print("‚úÖ Table created and active.")
    except ClientError as e:
        print("‚ùå Error creating table:", e)

# --- 2. ENABLE TTL ---
def enable_ttl():
    try:
        dynamodb.update_time_to_live(
            TableName=TABLE_NAME,
            TimeToLiveSpecification={"Enabled": True, "AttributeName": "expire_at"},
        )
        print("üïí TTL enabled (3 hours).")
    except Exception:
        print("TTL may already be enabled ‚Äî continuing...")

# --- 3. POPULATE SAMPLE DATA ---
def populate_sample_data():
    table = resource.Table(TABLE_NAME)

    sample_items = [
        {"sensor_type": "heart_rate", "value": 72, "unit": "bpm", "timestamp": "2025-10-19T09:00:00Z"},
        {"sensor_type": "oxygen", "value": 97, "unit": "%", "timestamp": "2025-10-19T09:00:00Z"},
        {"sensor_type": "temp_humidity", "value": "25¬∞C / 48%", "unit": "C/%", "timestamp": "2025-10-19T09:00:00Z"},
        {"sensor_type": "posture", "value": "sitting", "unit": None, "timestamp": "2025-10-19T09:01:00Z"},
        {"sensor_type": "pill_bottle", "value": "opened", "unit": None, "timestamp": "2025-10-19T09:02:30Z"},
        {"sensor_type": "heart_rate", "value": 78, "unit": "bpm", "timestamp": "2025-10-19T09:10:00Z"},
        {"sensor_type": "oxygen", "value": 96, "unit": "%", "timestamp": "2025-10-19T09:10:00Z"},
        {"sensor_type": "posture", "value": "standing", "unit": None, "timestamp": "2025-10-19T09:12:00Z"},
        {"sensor_type": "eating", "value": "meal_started", "unit": None, "timestamp": "2025-10-19T09:13:00Z"},
        {"sensor_type": "heart_rate", "value": 95, "unit": "bpm", "timestamp": "2025-10-19T09:15:00Z"},
        {"sensor_type": "oxygen", "value": 95, "unit": "%", "timestamp": "2025-10-19T09:15:00Z"},
        {"sensor_type": "posture", "value": "fallen", "unit": None, "timestamp": "2025-10-19T09:20:00Z"},
        {"sensor_type": "heart_rate", "value": 115, "unit": "bpm", "timestamp": "2025-10-19T09:20:30Z"},
        {"sensor_type": "fall_detector", "value": "triggered", "unit": None, "timestamp": "2025-10-19T09:20:30Z"},
        {"sensor_type": "oxygen", "value": 90, "unit": "%", "timestamp": "2025-10-19T09:20:30Z"},
        {"sensor_type": "heart_rate", "value": 75, "unit": "bpm", "timestamp": "2025-10-19T09:45:00Z"},
        {"sensor_type": "oxygen", "value": 98, "unit": "%", "timestamp": "2025-10-19T09:45:00Z"},
        {"sensor_type": "sleep", "value": "nap_started", "unit": None, "timestamp": "2025-10-19T10:00:00Z"},
    ]

    print("üß† Uploading sample data to DynamoDB...")
    for item in sample_items:
        item["expire_at"] = int(time.time()) + TTL_HOURS * 3600  # Auto-expire
        # Convert None to string "null" (DynamoDB doesn‚Äôt accept None directly)
        for k, v in list(item.items()):
            if v is None:
                item[k] = "null"
        table.put_item(Item=item)
    print("‚úÖ Sample data uploaded successfully!")

# --- 4. VERIFY ---
def show_preview():
    table = resource.Table(TABLE_NAME)
    response = table.scan(Limit=10)
    print("\nüìä Preview:")
    for i in response["Items"]:
        print(i)

if __name__ == "__main__":
    create_table_if_not_exists()
    enable_ttl()
    populate_sample_data()
    show_preview()
